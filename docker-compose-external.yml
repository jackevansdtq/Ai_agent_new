version: '3.8'

services:
  # Insurance Bot API - Main application
  insurance-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: insurance-bot
    environment:
      # API Configuration
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8001}
      API_DEBUG: ${API_DEBUG:-false}
      API_THREADED: ${API_THREADED:-true}
      API_SECRET_KEY: ${API_SECRET_KEY}
      REQUIRE_API_KEY: ${REQUIRE_API_KEY:-true}
      API_RATE_LIMIT: ${API_RATE_LIMIT:-100/hour}

      # Database Configuration - EXTERNAL NEO4J
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USERNAME: ${NEO4J_USERNAME}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      NEO4J_MAX_CONNECTION_POOL_SIZE: ${NEO4J_MAX_CONNECTION_POOL_SIZE:-50}

      # AI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      OPENAI_API_BASE: ${OPENAI_API_BASE}
      OPENAI_LLM_MODEL: ${OPENAI_LLM_MODEL:-gpt-4o-mini}
      OPENAI_LLM_MAX_TOKENS: ${OPENAI_LLM_MAX_TOKENS:-800}
      OPENAI_LLM_TEMPERATURE: ${OPENAI_LLM_TEMPERATURE:-0.7}

      # Embedding Configuration
      EMBEDDING_TYPE: ${EMBEDDING_TYPE:-openai}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}

      # MiniRAG Configuration
      WORKING_DIR: ${WORKING_DIR:-./}
      LLM_MODEL_DIR: ${LLM_MODEL_DIR:-./}
      NLTK_DATA: ${NLTK_DATA:-./nltk_data}

      # Swagger Configuration
      SWAGGER_URL: ${SWAGGER_URL:-/api/docs}
      API_SPEC_URL: ${API_SPEC_URL:-/api/spec}
    ports:
      - "${API_PORT:-8001}:8001"
    volumes:
      - ./data:/app/data
      - ./MiniRAG:/app/MiniRAG
      - ./logs:/app/logs
    networks:
      - insurance-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8001}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: insurance-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      insurance-bot:
        condition: service_healthy
    networks:
      - insurance-network
    restart: unless-stopped

  # Prometheus Monitoring (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: insurance-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - insurance-network
    restart: unless-stopped

  # Grafana Dashboard (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: insurance-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - insurance-network
    restart: unless-stopped

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  nginx_logs:
    driver: local

networks:
  insurance-network:
    driver: bridge
